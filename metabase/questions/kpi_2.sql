SELECT a.email_address AS "Conta", COUNT(e.id) AS "Enviados", SUM(CASE WHEN NOT e.is_bounced THEN 1 ELSE 0 END) AS "Entregues", SUM(CASE WHEN e.is_replied THEN 1 ELSE 0 END) AS "Respondidos", ROUND(100.0 * SUM(CASE WHEN NOT e.is_bounced THEN 1 ELSE 0 END) / NULLIF(COUNT(e.id), 0), 2) AS "Taxa Entrega (%)", ROUND(100.0 * SUM(CASE WHEN e.is_replied THEN 1 ELSE 0 END) / NULLIF(SUM(CASE WHEN NOT e.is_bounced THEN 1 ELSE 0 END), 0), 2) AS "Taxa Resposta (%)" FROM public.emails e JOIN public.accounts a ON e.account_id = a.id WHERE e.sent_datetime >= DATE_TRUNC('day', NOW() AT TIME ZONE 'America/Sao_Paulo') AND e.subject NOT ILIKE 'ENC:%' AND e.subject NOT ILIKE 'FW:%' GROUP BY 1 ORDER BY 3 DESC;
