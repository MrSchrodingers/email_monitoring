SELECT DATE_TRUNC('week', e.sent_datetime AT TIME ZONE 'America/Sao_Paulo')::date AS "Semana", a.email_address AS "Conta", ROUND(100.0*SUM(CASE WHEN NOT e.is_bounced THEN 1 ELSE 0 END)/NULLIF(COUNT(e.id),0),2) AS "Taxa de Entrega (%)", ROUND(100.0*SUM(CASE WHEN e.is_replied THEN 1 ELSE 0 END)/NULLIF(SUM(CASE WHEN NOT e.is_bounced THEN 1 ELSE 0 END),0),2) AS "Taxa de Resposta (%)" FROM public.emails e JOIN public.accounts a ON e.account_id=a.id WHERE e.sent_datetime >= (CURRENT_DATE - INTERVAL '90 days') AND e.subject NOT ILIKE 'ENC:%' AND e.subject NOT ILIKE 'FW:%' GROUP BY 1, 2 ORDER BY 1, 2;
