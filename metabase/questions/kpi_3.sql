SELECT a.email_address AS "Conta", ROUND(100.0 * SUM(e.is_replied::int) / NULLIF(SUM((NOT e.is_bounced)::int), 0), 2) AS "Taxa Resposta (%)", ROUND(AVG(e.engagement_score), 2) AS "Pontuação Média", ROUND((SUM(e.is_replied::int) / NULLIF(SUM((NOT e.is_bounced)::int), 0)) * AVG(e.engagement_score), 2) AS "Índice de Performance" FROM public.emails e JOIN public.accounts a ON a.id = e.account_id WHERE e.sent_datetime >= (CURRENT_DATE - INTERVAL '30 days') AND e.subject NOT ILIKE 'ENC:%' AND e.subject NOT ILIKE 'FW:%' GROUP BY 1 ORDER BY 4 DESC;
