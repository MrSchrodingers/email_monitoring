SELECT e.subject AS "Assunto", COUNT(*) AS "Enviados", SUM(e.is_replied::int) AS "Respostas", ROUND(100.0 * SUM(e.is_replied::int) / NULLIF(COUNT(*), 0), 2) AS "Taxa Resposta (%)", ROUND(AVG(e.engagement_score), 2) AS "Pontuação Média" FROM public.emails e WHERE e.sent_datetime >= (CURRENT_DATE - INTERVAL '90 days') AND e.is_bounced IS FALSE AND e.subject NOT ILIKE 'ENC:%' AND e.subject NOT ILIKE 'FW:%' GROUP BY 1 HAVING COUNT(*) >= 20 ORDER BY 5 DESC, 4 DESC LIMIT 20;
